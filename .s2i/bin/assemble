#!/bin/bash -e

# Don't use production environment, since we want to install the
# devDependencies
#export NODE_ENV=production

if [[ "$1" == "-h" ]]; then
  # If the 's2i-nodejs-nginx' assemble script is executed with '-h' flag,
  # print the usage.
  exec /usr/libexec/s2i/usage
fi

mkdir -p node_modules/.bin

/usr/libexec/s2i/restore-artifacts
/usr/libexec/s2i/install-source
/usr/libexec/s2i/setup-nginx-conf
/usr/libexec/s2i/setup-basic-auth
/usr/libexec/s2i/install-deps


# Replace /usr/libexec/s2i/compile-dist

export PATH=`npm bin`:$PATH
echo "npm bin dir:"
ls -l `npm bin`
SOURCES_PATH=`ng config "projects.$(ng config defaultProject).architect.build.options.outputPath"`
echo "SOURCES_PATH: $SOURCES_PATH"

echo "---> Compiling your static assets..."



npm run build
mv $SOURCE_PATH/* $SOURCES_PATH/..
rm -rf $SOURCE_PATH
ls -l $SOURCE_PATH/..

echo "---> Uploading source maps..."

# TODO


/usr/libexec/s2i/remove-temp-files

echo "---> Finished"
